<!DOCTYPE html>
<!--suppress CssUnresolvedCustomProperty -->
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>More Stars ‚Äî Mini App (Dark TWA)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg-1: #0e0f12;
      --bg-2: #131518;
      --card: rgba(255,255,255,0.04);
      --card-strong: rgba(255,255,255,0.06);
      --glass-weak: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.12);
      --text: #e9eef7;
      --muted: rgba(233,238,247,0.52);
      --accentA: #2a8bf2;
      --accentB: #8b5cff;
      --accentGrad: linear-gradient(135deg,var(--accentA),var(--accentB));
      --shadow-1: 0 8px 30px rgba(0,0,0,0.5);
      --nav-height: 84px;
      --radius-lg: 20px;
      --radius-md: 12px;
      --transition: 280ms cubic-bezier(.2,.9,.3,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(42,139,242,0.06), transparent 6%),
        radial-gradient(900px 400px at 90% 90%, rgba(139,92,255,0.04), transparent 6%),
        var(--bg-1);
      color:var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }

    .container { padding:18px; padding-bottom: calc(var(--nav-height) + 36px); width:100%; max-width:980px; margin:0 auto; flex:1; }
    .page{ display:none; animation: fadeUp .32s var(--transition) both; }
    .page.active{ display:block; }
    @keyframes fadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    .logo { display:block; width: 72vw; max-width: 420px; margin: 2.5vh auto 2vh; transform-origin:center; transition: transform 420ms cubic-bezier(.2,.9,.3,1); }
    .logo:active { transform: scale(.995); }

    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: var(--radius-lg);
      padding:14px;
      margin-bottom:14px;
      backdrop-filter: blur(12px) saturate(130%);
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }

    .actions { display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      width:100%; padding:14px; border-radius:14px; border:1px solid rgba(255,255,255,0.04);
      font-weight:700; font-size:15px; color: #fff;
      background: var(--accentGrad);
      box-shadow: 0 8px 28px rgba(42,139,242,0.08);
      transition: transform var(--transition), box-shadow var(--transition);
      cursor:pointer;
    }
    .btn:active{ transform: translateY(2px) scale(.995); box-shadow:0 6px 20px rgba(0,0,0,0.5); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      color:var(--text);
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:none;
    }

    .popular {
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:12px;
      align-items: start; /* –≤–æ—Ç —ç—Ç–æ –≤–∞–∂–Ω–æ */
    }

    .pkg {
      border-radius:14px; padding:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      display:flex; flex-direction:column; gap:8px; height:100px; justify-content:space-between;
      animation: pkgFadeUp 400ms forwards;
    }

    .pkg > .bottom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;       /* –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã */
      gap: 8px;
    }

    .pkg .price {
      white-space: nowrap;     /* —á—Ç–æ–±—ã "‚ÇΩ" –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è */
    }

    .pkg .btn {
      flex: 0 0 auto;    /* –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è –∏ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
      max-width: 50%;    /* –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–∞–∑–∏–ª–∞ */
      padding: 6px 10px; /* –º–æ–∂–Ω–æ —á—É—Ç—å —É–º–µ–Ω—å—à–∏—Ç—å */
      font-size: 13px;
    }

    @keyframes pkgFadeUp {
      0% { opacity: 0; transform: translateY(20px) scale(0.98); }
      60% { opacity: 1; transform: translateY(-4px) scale(1.02); }
      100% { transform: translateY(0) scale(1); }
    }

    .pkg .title{
      font-weight:800;
      font-size:14px;
    }
    .pkg .price{ color:var(--muted); font-size:13px; }

    .pkg .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:10px;
      font-weight:700; font-size:13px; color:#fff;
      background: linear-gradient(90deg, rgba(42,139,242,0.98), rgba(139,92,255,0.96));
      width:max-content;
    }
    .pkg.custom {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;   /* <-- —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
      min-height: 140px;     /* —á—Ç–æ–±—ã —Å–æ—Å–µ–¥–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∏—Å—å */
    }

    .pkg.custom .btn {
      margin-top: 6px;       /* –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ —Å–≤–µ—Ä—Ö—É */
      flex: 0 0 auto;        /* –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
      max-width: 80%;        /* –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã */
      text-align: center;
    }


    .qty {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color: var(--text);
      font-weight:700;
      font-size:15px;
      text-align:center;
      outline:none;
      transition: box-shadow 180ms ease, transform 180ms ease;
    }
    .qty:focus {
      box-shadow:0 6px 16px rgba(42,139,242,0.2);
      transform:translateY(-2px);
    }

    .pkg .btn {
      padding:6px 12px;
      font-size:13px;
      border-radius:8px;
      min-width:60px;
      text-align:center;
      transition: transform 180ms ease, box-shadow 180ms ease, background 180ms ease;
    }
    .pkg .btn:hover{
      transform: translateY(-2px);
      box-shadow:0 6px 16px rgba(42,139,242,0.2);
      background: linear-gradient(135deg, #2a8bf2, #8b5cff);
    }

    .profile-row{ display:flex; gap:12px; align-items:center; }
    .avatar{ width:80px; height:80px; border-radius:20px; object-fit:cover; border:1px solid rgba(255,255,255,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:2px; }
    .meta { flex:1; display:flex; flex-direction:column; gap:6px; }
    .label { color:var(--muted); font-size:13px; }
    .value { font-weight:700; font-size:15px; color:var(--text); }
    .select { background: rgba(0,0,0,0.06); border:none; color:var(--text); padding:8px 10px; border-radius:10px; }

    .skeleton { border-radius:10px; background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.08), rgba(255,255,255,0.03)); background-size:200% 100%; animation: shimmer 1.4s linear infinite; }
    @keyframes shimmer{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }

    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateZ(0); /* —Ñ–æ—Ä—Å–∏—Ä—É–µ–º GPU —Å–ª–æ–π */
      bottom: 18px;
      width: 92vw;
      max-width: 980px;
      height: var(--nav-height);
      border-radius: 28px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;

      /* —Ñ–æ–Ω —Å –±–æ–ª—å—à–µ–π –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ blur –Ω–∞ iOS */
      background: rgba(30,30,30,0.3);
      /* –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ */
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.08));

      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(60px) saturate(150%);
      -webkit-backdrop-filter: blur(60px) saturate(150%); /* –¥–ª—è Safari –Ω–∞ iOS */

      box-shadow: var(--shadow-1);
      z-index: 140;
      will-change: transform, backdrop-filter; /* –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }

    .nav-slot { flex:1; display:flex; justify-content:center; align-items:center; }
    .nav-item { display:flex; flex-direction:column; align-items:center; gap:6px; cursor:pointer; color:var(--muted); border-radius:16px; padding:6px 8px; transition: all 260ms cubic-bezier(.2,.9,.3,1); transform: translateY(0); user-select:none; }
    .nav-item .ico { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; transition: all 260ms; background: transparent; color:var(--text); }
    .nav-item.active { color:var(--text); transform:translateY(-6px); }
    .nav-item.active .ico { background: linear-gradient(135deg, rgba(42,139,242,0.16), rgba(139,92,255,0.12)); box-shadow:0 10px 28px rgba(42,139,242,0.06), inset 0 0 10px rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); transform:scale(1.04); }
    .nav-item .label { font-size:12px; color:var(--muted); }
    .nav-center { transform: translateY(-4px); }

    @keyframes walletPulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.03); opacity: 0.85; }
      100% { transform: scale(1); opacity: 1; }
    }

    .wallet-connecting {
      animation: walletPulse 0.8s ease-in-out infinite;
}

    .page {
  display: none;
    }

  .page.active {
    display: block;
  }

  </style>
</head>
<body>

<div id="auth-gate" style="display:none; padding:18px;">
  <div class="card" style="text-align:center; margin-top:20vh;">
    <img src="icon-1.png" style="width:120px; opacity:0.9; margin-bottom:18px;" />
    <div style="font-size:20px; font-weight:800; margin-bottom:12px;">
      –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
    </div>
    <div style="color:var(--muted); font-size:14px; margin-bottom:20px;">
      –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
    </div>

    <a href="https://t.me/more_stars_bot/app?startapp=1" class="btn" style="text-decoration:none;">
      –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
    </a>
  </div>
</div>

<div id="app-content">
  <main class="container">

    <section id="history" class="page">
      <div class="page-content">
        <div id="history-loader">
          <div class="card skeleton" style="height:64px"></div>
          <div class="card skeleton" style="height:64px"></div>
        </div>
        <div id="history-empty" class="card" style="display:none;">
          <div style="font-weight:700" data-i18n="last_purchases">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</div>
          <div style="margin-top:8px;color:var(--muted)" data-i18n="history_empty">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
        </div>
        <div id="history-list"></div>
      </div>

      <div class="auth-gate-inline" style="display:none;">
        <div class="card" style="text-align:center; margin-top:20vh;">
          <img src="icon-1.png" style="width:120px; opacity:0.9; margin-bottom:18px;" />
          <div style="font-size:20px; font-weight:800; margin-bottom:12px;">
            –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
          </div>
          <div style="color:var(--muted); font-size:14px; margin-bottom:20px;">
            –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </div>
          <a href="https://t.me/more_stars_bot/app?startapp=1" class="btn" style="text-decoration:none;">
            –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
          </a>
        </div>
      </div>
    </section>

    <section id="profile" class="page">
      <div class="page-content">
        <div class="card profile-row">
          <img id="user-avatar" class="avatar skeleton" alt="avatar" src="" />
          <div class="meta">
            <div><div class="label" data-i18n="username">Username</div><div class="value" id="user-username">‚Äî</div></div>
            <div><div class="label" data-i18n="id">ID</div><div class="value" id="user-id">‚Äî</div></div>
            <div><div class="label" data-i18n="language">–Ø–∑—ã–∫</div>
              <select id="lang-select" class="select"><option value="ru">RU</option><option value="en">EN</option></select>
            </div>
          </div>
        </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px" data-i18n="referral_system">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
      <div class="label" data-i18n="your_link">–í–∞—à–∞ —Å—Å—ã–ª–∫–∞</div>
      <a id="ref-link" class="value" href="#" target="_blank" style="color:var(--accentA);word-break:break-all">‚Äî</a>
      <div style="margin-top:12px"><div class="label" data-i18n="invited">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div><div class="value" id="ref-count">0</div></div>
    </div>

    <div class="card" id="wallet-card">
      <div style="font-weight:800;margin-bottom:8px" data-i18n="wallet">–ö–æ—à–µ–ª–µ–∫</div>

      <div class="label" data-i18n="status">–°—Ç–∞—Ç—É—Å</div>
      <div id="wallet-status" class="value" data-i18n="not_connected">–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</div>

      <div class="label" id="balance-label" style="display:none;margin-top:12px" data-i18n="balance">–ë–∞–ª–∞–Ω—Å</div>
      <div id="wallet-balance" class="value" style="display:none;margin-bottom:12px">0 TON</div>

      <button id="wallet-connect-btn" class="btn" style="margin-top: 12px" data-i18n="connect_wallet">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
    </div>

    <div class="card" style="text-align:center;">
      <div style="font-weight:800;margin-bottom:8px" data-i18n="contact_us">–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏</div>
      <button id="contact-support" class="btn" style="margin-top: 12px;" data-i18n="support">
        –ü–æ–¥–¥–µ—Ä–∂–∫–∞
      </button>
    </div>
  </div>

  <div class="auth-gate-inline" style="display:none;">
    <div class="card" style="text-align:center; margin-top:20vh;">
      <img src="icon-1.png" style="width:120px; opacity:0.9; margin-bottom:18px;" />
      <div style="font-size:20px; font-weight:800; margin-bottom:12px;">
        –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
      </div>
      <div style="color:var(--muted); font-size:14px; margin-bottom:20px;">
        –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </div>
      <a href="https://t.me/more_stars_bot/app?startapp=1" class="btn" style="text-decoration:none;">
        –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
      </a>
    </div>
  </div>
</section>

    <section id="shop" class="page active">
      <img src="icon-1.png" alt="More Stars" class="logo" />
      <div class="card actions" role="region" aria-label="Actions">
        <button id="buy-stars" class="btn" aria-label="–ö—É–ø–∏—Ç—å Stars" data-i18n="buy_stars">–ö—É–ø–∏—Ç—å Stars</button>
        <button id="buy-premium" class="btn secondary" aria-label="Telegram Premium" data-i18n="telegram_premium">Telegram Premium</button>
      </div>
      <div class="card" role="region" aria-label="–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–∞–∫–µ—Ç—ã">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:800;font-size:15px" data-i18n="popular_packages">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–∞–∫–µ—Ç—ã</div>
          <div style="color:var(--muted);font-size:13px" data-i18n="players_choice">–í—ã–±–æ—Ä –∏–≥—Ä–æ–∫–æ–≤</div>
        </div>
        <div class="popular" id="popular-grid" aria-live="polite"></div>
      </div>
    </section>

    <section id="buy-stars-page" class="page">
      <div class="popular" id="stars-grid" aria-live="polite"></div>
    </section>

    <section id="buy-premium-page" class="page">
      <div class="popular" id="premium-grid" aria-live="polite"></div>
    </section>

    <section id="recipient-page" class="page">
      <div class="card" style="padding:22px">
        <div style="font-weight:800;font-size:18px;margin-bottom:16px;text-align:center" data-i18n="send_to">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å?</div>

        <div class="actions" style="margin-top:12px;gap:12px">
          <button id="to-self" class="btn" data-i18n="to_self">–°–µ–±–µ</button>
          <button id="to-friend" class="btn secondary" data-i18n="to_friend">–î—Ä—É–≥—É</button>
        </div>

        <div id="friend-input-container" style="display:none;margin-top:18px">
          <div class="label" style="margin-bottom:8px" data-i18n="enter_friend_username">–í–≤–µ–¥–∏—Ç–µ @username –¥—Ä—É–≥–∞</div>
          <input type="text" id="friend-username" class="qty" placeholder="@username" />
          <button id="friend-next-btn" class="btn secondary" style="display:none;margin-top:16px;" data-i18n="next">
            –î–∞–ª–µ–µ
          </button>
        </div>
      </div>
      <img src="selectRecipient.gif"
           alt="Payment Animation"
           style="width:128px;margin: 0 auto 17px; display:block;opacity:0.9;" />
    </section>

    <section id="payment-page" class="page">
      <div class="page-content">
        <div id="payment-content">
          <div class="card" style="text-align:center;padding:22px">
            <div id="payment-title" style="font-weight:800;font-size:18px;margin-bottom:10px" data-i18n="purchase">
              –ü–æ–∫—É–ø–∫–∞
            </div>

            <div id="payment-amount" style="font-size:15px;color:var(--muted);margin-bottom:22px">
              ‚Äî
            </div>

            <div class="actions">
              <button class="btn" id="pay-wallet" data-i18n="pay_wallet">–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Wallet</button>
              <button class="btn" id="pay-cryptobot"
                      style="background:linear-gradient(135deg,#0088cc,#004c80)" data-i18n="crypto_bot">
                CryptoBot
              </button>
              <button class="btn secondary" id="pay-sbp" data-i18n="sbp">
                –°–ë–ü (–†–æ—Å—Å–∏–π—Å–∫–∏–µ –±–∞–Ω–∫–∏)
              </button>
            </div>
          </div>
          <img src="paymentLoading.gif"
               alt="Payment Animation"
               style="width:150px;margin:60px auto 0;display:block;opacity:0.9;" />
        </div>
      </div>
          <div class="auth-gate-inline" style="display:none;">
        <div class="card" style="text-align:center; margin-top:20vh;">
          <img src="icon-1.png" style="width:120px; opacity:0.9; margin-bottom:18px;" />
          <div style="font-size:20px; font-weight:800; margin-bottom:12px;">
            –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
          </div>
          <div style="color:var(--muted); font-size:14px; margin-bottom:20px;">
            –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </div>
          <a href="https://t.me/more_stars_bot/app?startapp=1" class="btn" style="text-decoration:none;">
            –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
          </a>
        </div>
      </div>
    </section>

    <section id="success-page" class="page">
      <div class="card" style="text-align:center;padding:22px">

        <div style="font-weight:800;font-size:20px;margin-bottom:8px" data-i18n="payment_successful">
          –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! üéâ
        </div>

        <div id="success-desc"
             style="font-size:15px;color:var(--muted);margin-bottom:22px" data-i18n="thank_you">
          –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É.
        </div>

        <button class="btn" id="success-back" style="margin-top: 50px" data-i18n="back_to_shop">
          –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
        </button>
      </div>

      <img src="paymentSuccess.gif"
           alt="Success"
           style="width:200px;margin:60px auto 0;display:block;opacity:0.9;" />

      <canvas id="confetti-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></canvas>

    </section>

    <section id="failure-page" class="page">
      <div class="card" style="text-align:center;padding:22px">

        <div id="failure-title" style="font-weight:800;font-size:18px;margin-bottom:10px;color:#ff4d4f;" data-i18n="payment_failed">
          –û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞
        </div>

        <div id="failure-desc" style="font-size:15px;color:var(--muted);margin-bottom:22px" data-i18n="payment_failed_desc">
          –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –æ–ø–ª–∞—Ç–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.
        </div>

        <div class="actions">
          <button class="btn" id="retry-payment" data-i18n="retry">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          <button class="btn secondary" id="go-shop" data-i18n="back_to_shop">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω</button>
        </div>
      </div>

      <img src="paymentFailure.gif"
           alt="Payment Failed"
           style="width:200px;margin:60px auto 0;display:block;opacity:0.9;" />
    </section>

  </main>

<!-- –ü–æ–¥–≤–∞–ª -->
<footer id="web-footer" class="card" style="margin-top:auto; margin-bottom: 100px; margin-left: 10px; margin-right: 10px">
  <div style="display:flex; flex-direction:column; gap:16px;">
    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
    <div>
      <h3 style="color:var(--accentA); margin-bottom:6px;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
      <p>–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: more-stars</p>
      <p>–ò–ù–ù: 645008281403</p>
      <p>–û–ì–†–ù/–û–ì–†–ù–ò–ü: -</p>
      <p>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: +7 909 331-18-86</p>
      <p>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π e-mail: workspace.alexey@gmail.com</p>
    </div>

    <!-- –ü—Ä–∞–π—Å -->
    <div>
      <h3 style="color:var(--accentA); margin-bottom:6px;">–û–ø–∏—Å–∞–Ω–∏–µ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥</h3>
      <p>–ü–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ:
        <a href="prices.docx" target="_blank" style="color:var(--accentB);">–°–∫–∞—á–∞—Ç—å prices.xls</a>
      </p>
    </div>

    <!-- –û—Ñ–µ—Ä—Ç–∞ -->
    <div>
      <h3 style="color:var(--accentA); margin-bottom:6px;">–û—Ñ–µ—Ä—Ç–∞</h3>
      <p>–¢–µ–∫—Å—Ç –æ—Ñ–µ—Ä—Ç—ã –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ:
        <a href="oferta.docx" target="_blank" style="color:var(--accentB);">–°–∫–∞—á–∞—Ç—å oferta.docx</a>
      </p>
    </div>
  </div>
</footer>


  <nav class="bottom-nav" role="navigation">
  <div class="nav-slot"><div class="nav-item" data-page="history"><div class="ico">üìú</div><div class="label">History</div></div></div>
  <div class="nav-slot"><div class="nav-item active nav-center" data-page="shop"><div class="ico">üõí</div><div class="label">Shop</div></div></div>
  <div class="nav-slot"><div class="nav-item" data-page="profile"><div class="ico">üë§</div><div class="label">Profile</div></div></div>
  </nav>
</div>
<script>

// –î–∞–Ω–Ω—ã–µ –æ –ø–æ–∫—É–ø–∫–µ
let currentPurchase = {
  id: null,
  title: null,
  price: null
};

// –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
const popularPackages=[
  {id:'p1',title:'100 ‚≠ê',price:'140 ‚ÇΩ',badge:'Best'},
  {id:'p2',title:'500 ‚≠ê',price:'700 ‚ÇΩ',badge:'Popular'},
  {id:'p3',title:'1200 ‚≠ê',price:'1680 ‚ÇΩ',badge:'Value'},
  {id:'p4',title:'2500 ‚≠ê',price:'3500 ‚ÇΩ',badge:'Top'},
  {id:'p5',  title:'300 ‚≠ê',   price:'420 ‚ÇΩ'},
  {id:'p6',  title:'500 ‚≠ê',   price:'700 ‚ÇΩ'}
];

// –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Stars
const starsPackages = [
  {id:'custom', title:'Custom ‚≠ê', custom:true},
  {id:'s50',   title:'50 ‚≠ê',    price:'70 ‚ÇΩ',   badge:'New'},
  {id:'s100',  title:'100 ‚≠ê',   price:'140 ‚ÇΩ',  badge:'Best'},
  {id:'s200',  title:'200 ‚≠ê',   price:'280 ‚ÇΩ',  badge:'Popular'},
  {id:'s300',  title:'300 ‚≠ê',   price:'420 ‚ÇΩ'},
  {id:'s500',  title:'500 ‚≠ê',   price:'700 ‚ÇΩ',  badge:'Popular'},
  {id:'s750',  title:'750 ‚≠ê',   price:'1050 ‚ÇΩ'},
  {id:'s1000', title:'1000 ‚≠ê',  price:'1400 ‚ÇΩ', badge:'Value'},
  {id:'s1200', title:'1200 ‚≠ê',  price:'1680 ‚ÇΩ', badge:'Value'},
  {id:'s1500', title:'1500 ‚≠ê',  price:'2100 ‚ÇΩ'},
  {id:'s2000', title:'2000 ‚≠ê',  price:'2800 ‚ÇΩ'},
  {id:'s2500', title:'2500 ‚≠ê',  price:'3500 ‚ÇΩ', badge:'Top'},
  {id:'s5000', title:'5000 ‚≠ê',  price:'7000 ‚ÇΩ', badge:'Mega'},
  {id:'s10000',title:'10000 ‚≠ê', price:'14000 ‚ÇΩ', badge:'Ultra'},
  {id:'s20000',title:'20000 ‚≠ê', price:'28000 ‚ÇΩ', badge:'Legend'}
];

// –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Premium
const premiumPackagesData = [
  {id:'prem1', title:'Premium 1 –≥–æ–¥', price:'299 ‚ÇΩ', badge:'Top'},
  {id:'prem3', title:'Premium 3 –º–µ—Å—è—Ü–∞', price:'799 ‚ÇΩ', badge:'Premium'},
  {id:'prem6', title:'Premium 6 –º–µ—Å—è—Ü–µ–≤', price:'1499 ‚ÇΩ', badge:'HOT'}
];

// –ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫
let walletConnected = false;

// –ò–Ω—Ñ–æ –æ –∫–æ—à–µ–ª—å–∫–µ
let walletInfo = {
  type: null,
  address: null,
  balance: null
};

let recipientMode = 'self';

let currentLang = 'ru'; // –≥–ª–æ–±–∞–ª—å–Ω–æ

const translations = {
    ru: {
      // History
      last_purchases: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏",
      history_empty: "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π",

      // Profile
      username: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
      id: "ID",
      language: "–Ø–∑—ã–∫",
      referral_system: "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
      your_link: "–í–∞—à–∞ —Å—Å—ã–ª–∫–∞",
      invited: "–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ",
      wallet: "–ö–æ—à–µ–ª–µ–∫",
      status: "–°—Ç–∞—Ç—É—Å",
      not_connected: "–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω",
      balance: "–ë–∞–ª–∞–Ω—Å",
      connect_wallet: "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫",
      contact_us: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏",
      support: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",

      // Shop
      buy_stars: "–ö—É–ø–∏—Ç—å Stars",
      telegram_premium: "Telegram Premium",
      popular_packages: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–∞–∫–µ—Ç—ã",
      players_choice: "–í—ã–±–æ—Ä –∏–≥—Ä–æ–∫–æ–≤",

      // Recipient
      send_to: "–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å?",
      to_self: "–°–µ–±–µ",
      to_friend: "–î—Ä—É–≥—É",
      enter_friend_username: "–í–≤–µ–¥–∏—Ç–µ @username –¥—Ä—É–≥–∞",
      next: "–î–∞–ª–µ–µ",

      // Payment
      purchase: "–ü–æ–∫—É–ø–∫–∞",
      pay_wallet: "–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Wallet",
      crypto_bot: "CryptoBot",
      sbp: "–°–ë–ü (–†–æ—Å—Å–∏–π—Å–∫–∏–µ –±–∞–Ω–∫–∏)",

      // Success
      payment_successful: "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! üéâ",
      thank_you: "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É.",
      back_to_shop: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω",

      // Failure
      payment_failed: "–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞",
      payment_failed_desc: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –æ–ø–ª–∞—Ç–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
      retry: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",

      // –ö–∞—Ä—Ç–æ—á–∫–∏
      buy: "buy"
    },
    en: {
      // History
      last_purchases: "Last purchases",
      history_empty: "History will appear here",

      // Profile
      username: "Username",
      id: "ID",
      language: "Language",
      referral_system: "Referral system",
      your_link: "Your link",
      invited: "Invited",
      wallet: "Wallet",
      status: "Status",
      not_connected: "Not connected",
      balance: "Balance",
      connect_wallet: "Connect wallet",
      contact_us: "Contact us",
      support: "Support",

      // Shop
      buy_stars: "Buy Stars",
      telegram_premium: "Telegram Premium",
      popular_packages: "Popular packages",
      players_choice: "Players' choice",

      // Recipient
      send_to: "Send to?",
      to_self: "Self",
      to_friend: "Friend",
      enter_friend_username: "Enter friend's @username",
      next: "Next",

      // Payment
      purchase: "Purchase",
      pay_wallet: "Pay with Wallet",
      crypto_bot: "CryptoBot",
      sbp: "SBP (Russian banks)",

      // Success
      payment_successful: "Payment successful! üéâ",
      thank_you: "Thank you for your purchase.",
      back_to_shop: "Back to shop",

      // Failure
      payment_failed: "Payment failed",
      payment_failed_desc: "Unfortunately, payment was not completed. Try again.",
      retry: "Try again",

      // –ö–∞—Ä—Ç–æ—á–∫–∏
      buy: "Buy"
    }
  };

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
document.querySelectorAll('.nav-item').forEach(n=>{
  n.addEventListener('click',()=>switchPage(n.dataset.page,n));
  n.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();n.click();}});
});

// –ö–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞
document.getElementById('buy-stars').addEventListener('click',()=>{
  switchPage('buy-stars-page');
  renderGrid('stars-grid', starsPackages);
});
document.getElementById('buy-premium').addEventListener('click',()=>{
  switchPage('buy-premium-page');
  renderGrid('premium-grid', premiumPackagesData);
});

// –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
document.getElementById("wallet-connect-btn").addEventListener("click", () => {
  const card = document.getElementById("wallet-card");

  if (!walletConnected) {

    // --- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ---
    card.classList.add("wallet-connecting");

    // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É (TON Connect)
    setTimeout(() => {

      // –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      walletConnected = true;
      walletInfo = {
        type: "Tonkeeper",
        address: "EQC1qwertyasdfghjklzxcvbnm123456789zpQn",
        balance: (Math.random() * 42 + 1).toFixed(2) // –ø—Ä–æ—Å—Ç–æ —Ä–∞–Ω–¥–æ–º–Ω—ã–π –±–∞–ª–∞–Ω—Å
      };

      updateWalletUI();
    }, 1200);

  } else {
    walletConnected = false;
    walletInfo = { type: null, address: null, balance: null };
    updateWalletUI();
  }
});

// –ö–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
document.getElementById("pay-wallet").addEventListener("click", () => {
      // –ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏
    const success = true; // –º–æ–∫
    if(success){
      openSuccessPage(currentPurchase);
    } else {
      openFailurePage(currentPurchase);
    }
  });
document.getElementById("pay-cryptobot").onclick = async () => {
  if(!currentPurchase) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä");

  // –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –Ω–∞ –±–µ–∫–µ–Ω–¥–µ
  const userId = document.getElementById("user-id").textContent;
  const amountValue = parseFloat(currentPurchase.price.replace(/[^0-9.]/g,""));
  const response = await fetch("/create_order", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: userId,
      recipient: currentPurchase.recipient || "self",
      product: currentPurchase.title,
      amount: amountValue,
      currency: "USDT" // –∏–ª–∏ –¥—Ä—É–≥–∞—è –≤–∞–ª—é—Ç–∞
    })
  });

  const data = await response.json();
  console.log("–°–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑:", data);

  if(data.crypto_invoice && data.crypto_invoice.result && data.crypto_invoice.result.pay_url){
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –≤ Telegram
    Telegram.WebApp.openTelegramLink(data.crypto_invoice.result.pay_url);

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
    const orderId = data.order_id;
    const interval = setInterval(async () => {
      const statusRes = await fetch(`/order_status?order_id=${orderId}`);
      const statusData = await statusRes.json();
      console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:", statusData);

      if(statusData.status === "paid"){
        clearInterval(interval);
        openSuccessPage(currentPurchase);
      }
    }, 5000); // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  } else {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞");
  }
};

document.getElementById("pay-sbp").onclick = async () => {
  if(!currentPurchase) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä");

  const userId = document.getElementById("user-id").textContent;
  const amountValue = parseFloat(currentPurchase.price.replace(/[^0-9.]/g,""));

  // POST –Ω–∞ –≤–∞—à –±–µ–∫–µ–Ω–¥ /create_order_robokassa
  const response = await fetch("/create_order_robokassa", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: userId,
      recipient: currentPurchase.recipient || "self",
      product: currentPurchase.title, // s50, s300, s500 –∏ —Ç.–¥.
      amount: amountValue,
      currency: "RUB"
    })
  });

  const data = await response.json();
  console.log("–°–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ Robokassa:", data);

  if(data.payment_url){
    // –æ—Ç–∫—Ä—ã–≤–∞–µ–º Robokassa –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
    window.open(data.payment_url, "_blank");

    const orderId = data.invoice_id;
    const interval = setInterval(async () => {
      const s = await fetch(`/order_status?order_id=${orderId}`);
      const sd = await s.json();

      if(sd.status === "paid"){
        clearInterval(interval);
        openSuccessPage(currentPurchase);
      }
      if(sd.status === "failed"){
        clearInterval(interval);
        openFailurePage(currentPurchase);
      }
    }, 5000);

  } else {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞: " + JSON.stringify(data));
  }
};

updateWalletUI();
// –ö–Ω–æ–ø–∫–∞ –ø–æ—Å–ª–µ —É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
document.getElementById("success-back").addEventListener("click", () => {
  switchPage("shop");
});

// –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
document.getElementById("retry-payment").addEventListener("click", () => {
  if(currentPurchase) openPaymentPage(currentPurchase);
});
document.getElementById("go-shop").addEventListener("click", () => {
  switchPage("shop");
});

// –ö–Ω–æ–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
document.getElementById("contact-support").addEventListener("click", () => {
  // –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å Telegram-—á–∞—Ç —Å –±–æ—Ç–æ–º –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É
  window.open("https://t.me/more_stars_support", "_blank");
});

// –ö–Ω–æ–ø–∫–∞ "–°–µ–±–µ"
document.getElementById('to-self').addEventListener('click', () => {
  let selfUser = '@unknown';
  if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
    const user = Telegram.WebApp.initDataUnsafe.user;
    selfUser = user.username ? `@${user.username}` : (user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
  }
  proceedToPayment(selfUser);
});

// –ö–Ω–æ–ø–∫–∞ "–î—Ä—É–≥—É"
document.getElementById('to-friend').addEventListener('click', () => {
  document.getElementById('friend-input-container').style.display = 'block';
  const input = document.getElementById('friend-username');
  const btn = document.getElementById('friend-next-btn');

  input.value = '';
  btn.style.display = 'none';
  input.focus();

  const checkInput = () => {
    const val = input.value.trim();
    if (isValidTelegramUsername(val)) {
      btn.style.display = 'block';
    } else {
      btn.style.display = 'none';
    }
  };

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
  input.oninput = checkInput;
  btn.onclick = () => {
    let val = input.value.trim();
    if (!val.startsWith('@')) val = '@' + val;
    proceedToPayment(val);
  };
});

// –Ø –Ω–µ –∑–Ω–∞—é —á—Ç–æ —ç—Ç–æ, –Ω–∞–≤–µ—Ä–Ω–æ–µ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
function el(tag,props={},children=[]){
  const node=document.createElement(tag);
  Object.entries(props).forEach(([k,v])=>{
    if(k==='class') node.className=v;
    else if(k==='text') node.textContent=v;
    else node.setAttribute(k,v);
  });
  children.forEach(c=>node.appendChild(typeof c==='string'?document.createTextNode(c):c));
  return node;
}

// –û—Ç–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã
function openPaymentPage(pkg) {
  currentPurchase = pkg;

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–∫—É–ø–∫–∏
  document.getElementById("payment-title").textContent = pkg.title;

  // –°—É–º–º–∞
  document.getElementById("payment-amount").textContent = `${pkg.price}`;


  switchPage("payment-page");
}

// –†–µ–Ω–¥–µ—Ä –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
function renderPopular(){
  const grid=document.getElementById('popular-grid');
  grid.innerHTML='';
  popularPackages.forEach((pkg,i)=>{
    const card=el('div',{class:'pkg',role:'button',tabindex:'0','aria-label':`${pkg.title} ${pkg.price}`});
    const top=el('div',{style:'display:flex;justify-content:space-between;align-items:center'},[
      el('div',{class:'title',text:pkg.title}),
      el('div',{class:'badge',text:pkg.badge})
    ]);
    const bottom=el('div',{style:'display:flex;justify-content:space-between;align-items:center'},[
      el('div',{class:'price',text:pkg.price}),
      el('button',{class:'btn',text:'buy','data-i18n':'buy'})
    ]);
    bottom.querySelector('button').addEventListener('click',()=>openRecipientPage(pkg));
    card.appendChild(top);
    card.appendChild(el('div',{style:'height:6px'}));
    card.appendChild(bottom);
    card.style.animationDelay = `${i*80}ms`;
    grid.appendChild(card);
  });
  setLanguage(localStorage.getItem('en') || 'en');
}
(function preloadPopular(){
  const grid=document.getElementById('popular-grid');
  for(let i=0;i<4;i++){
    const s=el('div',{class:'pkg skeleton'});
    s.style.height='86px';
    grid.appendChild(s);
  }
  setTimeout(()=> renderPopular(),650);
})();

// –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–ø–∞–Ω–µ–ª—å—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
function switchPage(id,node){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const page=document.getElementById(id);
  if(page) page.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>{
    n.classList.remove('active'); n.setAttribute('aria-pressed','false');
  });
  if(node){ node.classList.add('active'); node.setAttribute('aria-pressed','true'); }
  else{ const target=document.querySelector(`.nav-item[data-page="${id}"]`); if(target){ target.classList.add('active'); target.setAttribute('aria-pressed','true'); }}
  window.scrollTo({top:0,behavior:'smooth'});
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Profile
function setUserFromTelegram(){
  try{
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe){
      const user=Telegram.WebApp.initDataUnsafe.user;
      if(user){
        const uname=document.getElementById('user-username');
        const uid=document.getElementById('user-id');
        const avatar=document.getElementById('user-avatar');
        const ref=document.getElementById('ref-link');
        uname.textContent=user.username?`@${user.username}`:(user.first_name||'User');
        uid.textContent=user.id||'';
        ref.textContent=`https://t.me/more_stars_bot?start=${user.id}`;
        ref.href=`https://t.me/more_stars_bot?start=${user.id}`;
        if(user.photo_url){
          const i=new Image();
          i.onload=()=>{ avatar.src=user.photo_url; avatar.classList.remove('skeleton'); };
          i.onerror=()=>{ avatar.src='https://via.placeholder.com/80/0e0f12/ffffff?text=U'; avatar.classList.remove('skeleton'); };
          i.src=user.photo_url;
        } else { avatar.src='https://via.placeholder.com/80/0e0f12/ffffff?text=U'; avatar.classList.remove('skeleton'); }
      }
    } else {
      const avatar=document.getElementById('user-avatar');
      document.getElementById('user-username').textContent='@demo_user';
      document.getElementById('user-id').textContent='123456';
      document.getElementById('ref-link').textContent='https://t.me/more_stars_bot?start=123456';
      document.getElementById('ref-link').href='https://t.me/more_stars_bot?start=123456';
      avatar.src='https://via.placeholder.com/80/0e0f12/ffffff?text=D'; avatar.classList.remove('skeleton');
    }
  }catch(e){ console.warn('Telegram init read error',e); }
}
setUserFromTelegram();

async function loadHistory(userId) {
  const loader = document.getElementById("history-loader");
  const empty = document.getElementById("history-empty");
  const list = document.getElementById("history-list");

  loader.style.display = "block";
  empty.style.display = "none";
  list.innerHTML = "";

  try {
    const response = await fetch(`/order_history?user_id=${userId}`);
    const data = await response.json();

    loader.style.display = "none";

    if (data.orders && data.orders.length > 0) {
      data.orders.forEach(order => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "8px";

        // –¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
        let color = "gray";
        if(order.status === "paid") color = "green";
        else if(order.status === "failed") color = "red";

        card.innerHTML = `
          <div><b>${order.product}</b> ‚Äî ${order.amount_rub} ‚ÇΩ (${order.currency})</div>
          <div style="color:${color}; font-size:12px;">${new Date(order.timestamp).toLocaleString()} ‚Äî ${order.status}</div>
        `;
        list.appendChild(card);
      });
    } else {
      empty.style.display = "block";
    }
  } catch (err) {
    loader.style.display = "none";
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", err);
  }
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã History
function loadUserHistory() {
  try {
    if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe){
      const userId = Telegram.WebApp.initDataUnsafe.user.id;
      if(userId){
        loadHistory(userId);
      }
    }
  } catch(e){ console.warn('Telegram init read error', e); }
}
loadUserHistory();

// –†–µ–Ω–¥–µ—Ä Stars –∏ Premium
function renderGrid(gridId, packages){
  const grid = document.getElementById(gridId);
  grid.innerHTML = '';

  packages.forEach((pkg, i) => {
    const card = el('div', {
      class: 'pkg',
      role: 'button',
      tabindex: '0',
      'aria-label': `${pkg.title} ${pkg.price || ''}`
    });
    card.style.animationDelay = `${i * 80}ms`;

    if(pkg.custom){
      // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
      const title = el('div', { class: 'title', text: pkg.title });
      const input = el('input', {
        type: 'number',
        class: 'qty',
        id: 'stars-input-custom',
        placeholder: '50‚Äì20000',
        min: 50,
        max: 20000
      });
      const btn = el('button', { class: 'btn', text: 'buy' });

      // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      btn.style.alignSelf = 'center';

      // –°–æ–±—ã—Ç–∏–µ –ø–æ–∫—É–ø–∫–∏
      btn.addEventListener('click', () => {
        let val = parseInt(input.value);
        if (isNaN(val) || val < 50) val = 50;
        if (val > 20000) val = 20000;
        input.value = val;
        openRecipientPage({
          id: "custom",
          title: `${val} ‚≠ê`,
          price: val + " ‚ÇΩ"
        });
      });

      input.addEventListener('blur', () => {
        let val = parseInt(input.value);
        if (isNaN(val) || val < 50) val = 50;
        if (val > 20000) val = 20000;
        input.value = val;
      });

      card.appendChild(title);
      card.appendChild(input);
      card.appendChild(btn);
      card.classList.add('custom');

      card.style.gridColumn = 'span 2';

    } else {
      // –û–±—ã—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
      const topChildren = [el('div', { class: 'title', text: pkg.title })];
      if(pkg.badge) topChildren.push(el('div', { class: 'badge', text: pkg.badge }));

      const top = el('div', { style: 'display:flex;justify-content:space-between;align-items:center' }, topChildren);

      const bottom = el('div', { class: 'bottom-row' }, [
        el('div', { class: 'price', text: pkg.price }),
        el('button', { class: 'btn', text: 'buy' })
      ]);

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
      bottom.querySelector('button').addEventListener('click', () => {
        openRecipientPage(pkg);
      });

      card.appendChild(top);
      card.appendChild(el('div', { style: 'height:6px' }));
      card.appendChild(bottom);
    }

    grid.appendChild(card);
  });
}

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
function updateWalletUI() {
  const status = document.getElementById("wallet-status");
  const balanceLabel = document.getElementById("balance-label");
  const balance = document.getElementById("wallet-balance");
  const btn = document.getElementById("wallet-connect-btn");
  const card = document.getElementById("wallet-card");

  if (walletConnected && walletInfo.type && walletInfo.address) {

    // –∫–æ—Ä–æ—Ç–∫–∏–π –∞–¥—Ä–µ—Å
    const shortAddr = walletInfo.address.slice(0, 4) + "‚Ä¶" + walletInfo.address.slice(-4);

    status.textContent = `${walletInfo.type} (${shortAddr})`;
    status.style.color = "var(--accentA)";

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
    balanceLabel.style.display = "block";
    balance.style.display = "block";
    balance.textContent = `${walletInfo.balance} TON`;

    btn.textContent = "–û—Ç–∫–ª—é—á–∏—Ç—å Wallet";
    btn.classList.add("secondary");

    card.classList.remove("wallet-connecting");

  } else {
    status.textContent = "–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω";
    status.style.color = "var(--muted)";

    balanceLabel.style.display = "none";
    balance.style.display = "none";

    btn.textContent = "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫";
    btn.classList.remove("secondary");

    card.classList.remove("wallet-connecting");
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è
function openRecipientPage(pkg) {
  currentPurchase = { ...pkg };
  document.getElementById('friend-input-container').style.display = 'none';
  switchPage("recipient-page");
}

function isValidTelegramUsername(val) {
  if (!val) return false;
  val = val.startsWith('@') ? val.slice(1) : val;
  return /^[a-zA-Z0-9_]{3,32}$/.test(val);
}

function proceedToPayment(recipient) {
  currentPurchase.recipient = recipient;
  openPaymentPage(currentPurchase);
}

// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–µ
function openSuccessPage(pkg) {
  if(!pkg || !pkg.title) {
    // –ï—Å–ª–∏ –ø–∞–∫–µ—Ç–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
    window.location.href = '/success.html';
    return;
  }
  // –ö–æ–¥–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –¥–ª—è URL
  const pkgTitle = encodeURIComponent(pkg.title);
  window.location.href = `/success.html?title=${pkgTitle}`;
}

// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–ø–ª–∞—Ç—ã
function openFailurePage(pkg) {
  if(pkg && pkg.title){
    const pkgTitle = encodeURIComponent(pkg.title);
    window.location.href = `/failure.html?title=${pkgTitle}`;
  } else {
    window.location.href = `/failure.html`;
  }
}

localStorage.setItem('lang', 'ru');

async function initWebApp() {
  const userId = document.getElementById("user-id").textContent;

  try {
    const res = await fetch(`/last_order_status?user_id=${userId}`);
    const data = await res.json();

    if (data.show_success_page) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
      openSuccessPage({ title: data.product });
    } else if (data.show_failure_page) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
      openFailurePage({ title: data.product });
    } else {
      // –û–±—ã—á–Ω–∞—è —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
      switchPage("shop");
    }
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebApp:", err);
    switchPage("shop"); // fallback
  }
}
// –í—ã–∑—ã–≤–∞–µ–º initWebApp —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ HTML
window.addEventListener("DOMContentLoaded", async () => {

  const isTelegram = !!window.Telegram?.WebApp?.initDataUnsafe?.user;

  ['profile','history','payment-page'].forEach(id => {
    const page = document.getElementById(id);
    if (!page) return;

    page.querySelector('.page-content').style.display = isTelegram ? 'block' : 'none';
    page.querySelector('.auth-gate-inline').style.display = isTelegram ? 'none' : 'block';
  });
  const footer = document.getElementById('web-footer');
  if (isTelegram) {
    footer.style.display = 'none';
  } else {
    footer.style.display = 'block';
  }

  // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å–∞–π—Ç–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  if (isTelegram || !['profile','history','payment-page'].includes(currentPage)) {
    document.getElementById("app-content").style.display = "block";
  }

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp ---
  const userId = document.getElementById("user-id").textContent;
  try {
    const res = await fetch(`/last_order_status?user_id=${userId}`);
    const data = await res.json();

    if (data.show_success_page) {
      openSuccessPage({title: data.product});
    } else if (data.show_failure_page) {
      openFailurePage({title: data.product});
    } else {
      switchPage("shop");
    }
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebApp:", err);
    switchPage("shop");
  }

  function setLanguage(lang) {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[lang] && translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });
    renderPopular();
  }

  // --- –°–µ–ª–µ–∫—Ç–æ—Ä —è–∑—ã–∫–∞ ---
  const langSelect = document.getElementById('lang-select');
  langSelect.addEventListener('change', () => {
    const lang = langSelect.value;
    setLanguage(lang);
    localStorage.setItem('lang', lang);
  });

  const savedLang = localStorage.getItem('lang') || 'ru';
  langSelect.value = savedLang;
  setLanguage(savedLang);



});


</script>
</body>
</html>
